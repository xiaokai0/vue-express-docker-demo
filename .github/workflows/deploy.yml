name: Build and Deploy to Server

# 触发条件：仅在 main 分支 push 时执行（通常部署只在合并到主分支后进行）
on:
  push:
    branches: [ master ]

jobs:
  # 构建阶段：在 GitHub 服务器上构建 Docker 镜像
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 构建并保存前端镜像
      - name: Build and save frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          tags: frontend:latest
          outputs: type=docker,dest=/tmp/frontend.tar

      # 构建并保存后端镜像
      - name: Build and save backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: backend:latest
          outputs: type=docker,dest=/tmp/backend.tar

      # 上传镜像作为 Artifact
      - name: Upload images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: /tmp/*.tar
          retention-days: 1 # 只保留1天，节省存储空间

  # 部署阶段：把构建好的镜像传输到服务器并启动
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production # 关联到 production 环境，便于授权和管理

    steps:
      # 下载构建好的镜像
      - name: Download docker images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /tmp

      # 加载镜像
      - name: Load docker images
        run: |
          docker load --input /tmp/frontend.tar
          docker load --input /tmp/backend.tar

      # 配置 SSH（使用预先生成的私钥）
      - name: Configure SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }} # 使用预存在 Secrets 中的私钥

      # 步骤 1：把镜像传输到服务器
      - name: Transfer images to server
        run: |
          # 使用 ssh-agent 简化 scp 命令，无需每次指定 -i
          docker save frontend:latest | ssh ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "docker load"
          docker save backend:latest | ssh ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "docker load"

      # 步骤 2：传输 docker-compose.yml 到服务器
      - name: Transfer docker-compose.yml
        run: |
          scp docker-compose.yml ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}:~/

      # 步骤 3：在服务器上启动容器
      - name: Deploy on server
        run: |
          ssh ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "cd ~ && docker-compose down && docker-compose up -d"