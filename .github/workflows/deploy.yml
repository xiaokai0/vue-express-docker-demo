name: Build and Deploy to Server

# 触发条件：main 分支有 push 或 pull_request 时执行
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # 构建阶段：在 GitHub 服务器上构建 Docker 镜像
  build:
    runs-on: ubuntu-latest # 运行环境（Ubuntu 最新版）

    steps:
      # 步骤 1：拉取 GitHub 仓库代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 步骤 2：设置 Docker Buildx（优化构建速度）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 步骤 3：构建前端镜像
      - name: Build frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: false # 暂时不推送到镜像仓库（直接打包传输到服务器）
          tags: frontend:latest
          outputs: type=docker,dest=/tmp/frontend.tar # 打包镜像到临时文件

      # 步骤 4：构建后端镜像
      - name: Build backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: false
          tags: backend:latest
          outputs: type=docker,dest=/tmp/backend.tar

      # 步骤 5：保存镜像为 artifact（供部署阶段使用）
      - name: Upload images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: /tmp/*.tar

  # 部署阶段：把构建好的镜像传输到服务器并启动
  deploy:
    needs: build # 依赖 build 阶段完成
    runs-on: ubuntu-latest

    steps:
      # 步骤 1：下载 build 阶段的镜像 artifact
      - name: Download docker images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /tmp

      # 步骤 2：加载镜像（解压 tar 文件）
      - name: Load docker images
        run: |
          docker load --input /tmp/frontend.tar
          docker load --input /tmp/backend.tar

      # 步骤 3：配置 SSH（连接服务器）
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 步骤 4：把镜像传输到服务器
      - name: Transfer images to server
        run: |
          docker save frontend:latest | ssh ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "docker load"
          docker save backend:latest | ssh ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "docker load"

      # 步骤 5：传输 docker-compose.yml 到服务器
      - name: Transfer docker-compose.yml
        run: |
          scp docker-compose.yml ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}:~/

      # 步骤 6：在服务器上启动容器（停止旧容器，启动新容器）
      - name: Deploy on server
        run: |
          ssh ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "cd ~ && docker-compose down && docker-compose up -d"